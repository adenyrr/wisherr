# Wisherr nginx proxy configuration (ANONYMIZED)
# Version: 2026-01-17
# Purpose: reverse-proxy frontend and backend for a Wisherr subdomain
# Prérequis:
# - DNS: créer un A/CNAME pour <SUBDOMAIN> pointant vers le proxy public
# - TLS: géré par le proxy via /config/nginx/ssl.conf
# - Remplacer les placeholders ci-dessous par vos valeurs réelles avant déploiement
# Placeholders:
#   <SUBDOMAIN>        ex: wisherr.example.com
#   <FRONTEND_HOST>    ex: 10.10.10.2 ou nom de service Docker (frontend)
#   <FRONTEND_PORT>    ex: 80
#   <BACKEND_HOST>     ex: 10.10.10.2 ou nom de service Docker (backend)
#   <BACKEND_PORT>     ex: 8000

server {
    listen 80;
    listen [::]:80;
    server_name <SUBDOMAIN>;

    # Redirige tout HTTP vers HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name <SUBDOMAIN>;

    # TLS fourni par l'environnement proxy
    include /config/nginx/ssl.conf;

    client_max_body_size 0;

    # Racine -> frontend (application SPA)
    location / {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;

        # En-têtes standard
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Support WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $http_connection;

        # Proxy vers le frontend (remplacer placeholders)
        proxy_pass http://<FRONTEND_HOST>:<FRONTEND_PORT>;
    }

    # API : /api/* -> backend
    location ~ ^/api(/|$) {
        include /config/nginx/proxy.conf;
        include /config/nginx/resolver.conf;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $http_connection;

        # Proxy vers le backend API (remplacer placeholders)
        proxy_pass http://<BACKEND_HOST>:<BACKEND_PORT>;
    }

    # Point de santé simple
    location = /health {
        return 200 "ok";
        add_header Content-Type text/plain;
    }
}
