# GitLab CI pipeline pour le projet Wisherr
# -----------------------------
# Objectif :
# - Linter, tester et construire le backend (Python/Poetry) et le frontend (Node)
# - Construire des images Docker et (optionnel) les pousser vers un registry
# - Fournir des artefacts pour inspection (build, reports)
#
# Variables importantes (à définir dans GitLab CI/CD > Settings > CI/CD > Variables) :
# - CI_REGISTRY: (optionnel) URL du registry (souvent fourni automatiquement par GitLab)
# - CI_REGISTRY_USER / CI_REGISTRY_PASSWORD: identifiants pour docker login (utilisé par docker-push)
# - DOCKER_IMAGE_PREFIX: Préfixe pour les images Docker (par défaut $CI_REGISTRY_IMAGE)
# - POSTGRES_*: Utilisées pour les tests backend (POSTGRES_USER/PASSWORD/DB)
# - Toute autre variable secrète (SECRET_KEY, SMTP credentials, etc.)
#
# Notes :
# - Le job `docker-push` est manuel par sécurité (push vers registry), activez-le si vous avez configuré les variables ci-dessus.
# - Les jobs lint autorisent l'échec (allow_failure) afin de ne pas bloquer le pipeline si vous n'avez pas encore tout configuré.
# - Les artefacts de test/build sont conservés 1 semaine par défaut et peuvent être récupérés depuis l'UI.
stages:
  - lint
  - test
  - build
  - docker
  - deploy

variables:
  POSTGRES_DB: wisherr_test
  POSTGRES_USER: wisherr
  POSTGRES_PASSWORD: wisherr
  # Optional registry variables (set in CI/CD settings)
  DOCKER_IMAGE_PREFIX: "wisherr"

# ---------------------------
# Lint jobs
# ---------------------------
# Linting (backend) : vérifie la qualité du code Python (ruff)
backend-lint:
  image: python:3.11-slim
  stage: lint
  before_script:
    - echo "Diagnostic - Répertoire courant:"
    - pwd
    - ls -la
    - python -m pip install --upgrade pip
    - pip install ruff
  script:
    - ruff check backend || true
  allow_failure: true
  # NOTE: allow_failure=true permet de ne pas bloquer le pipeline si le lint signale des avertissements.

# Linting (frontend) : exécute `npm run lint` si présent
frontend-lint:
  image: node:18
  stage: lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - frontend/node_modules/
  script:
    - cd frontend
    - npm ci
    - npm run lint --if-present || echo "No frontend lint script"
  allow_failure: true
  # NOTE: ajoutez un script lint dans package.json pour activer cette vérification.

# ---------------------------
# Tests
# ---------------------------
# Backend tests : exécute les tests unitaires avec une base Postgres temporaire
backend-tests:
  image: python:3.11-slim
  stage: test
  services:
    - name: postgres:15
      alias: postgres
  variables:
    DATABASE_URL: "postgresql://$POSTGRES_USER:$POSTGRES_PASSWORD@postgres:5432/$POSTGRES_DB"
  before_script:
    - cd backend
    - python -m pip install --upgrade pip
    - pip install poetry
    - poetry config virtualenvs.create false
    - poetry install --no-interaction --no-ansi
  script:
    - mkdir -p reports
    - poetry run pytest -q --junitxml=reports/junit.xml || true
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - backend/.pytest_cache/
      - backend/reports/
  # Variables utiles à définir (ex. dans GitLab CI settings):
  # - POSTGRES_USER / POSTGRES_PASSWORD / POSTGRES_DB (déjà par défaut ci-dessus)
  # - SECRET_KEY (valeur pour les tests si nécessaire)

backend-security:
  image: python:3.11-slim
  stage: test
  before_script:
    - python -m pip install --upgrade pip
    - pip install bandit
  script:
    - cd backend
    - bandit -r app -f json -o bandit-report.json || true
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - backend/bandit-report.json

frontend-build:
  image: node:18
  stage: build
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - frontend/node_modules/
  script:
    - cd frontend
    - npm ci
    - CI=false npm run build
  artifacts:
    paths:
      - frontend/build
    expire_in: 1 week

frontend-security:
  image: node:18
  stage: test
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - frontend/node_modules/
  script:
    - cd frontend
    - npm ci
    - npm audit --audit-level=moderate || true
  allow_failure: true

# ---------------------------
# Docker build & push
# ---------------------------
# Docker build : construit les images Docker (tagged par commit short sha)
docker-build:
  image: docker:25-cli
  stage: docker
  services:
    - docker:25-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  before_script:
    - echo "Building Docker images with tag ${CI_COMMIT_SHORT_SHA}"
    - docker info
  script:
    - docker build -t ${DOCKER_IMAGE_PREFIX}/wisherr-backend:${CI_COMMIT_SHORT_SHA} ./backend
    - docker build -t ${DOCKER_IMAGE_PREFIX}/wisherr-frontend:${CI_COMMIT_SHORT_SHA} -f ./frontend/Dockerfile.prod ./frontend
    - docker tag ${DOCKER_IMAGE_PREFIX}/wisherr-backend:${CI_COMMIT_SHORT_SHA} ${DOCKER_IMAGE_PREFIX}/wisherr-backend:latest
    - docker tag ${DOCKER_IMAGE_PREFIX}/wisherr-frontend:${CI_COMMIT_SHORT_SHA} ${DOCKER_IMAGE_PREFIX}/wisherr-frontend:latest
  only:
    - main
    - master

# Docker push (manuel) : tag and push images to container registry
# Requires the following CI variables to be set in GitLab project settings:
# - CI_REGISTRY (URL fourni automatiquement dans GitLab Hosted)
# - CI_REGISTRY_USER (ou CI_REGISTRY_USER fourni automatiquement)
# - CI_REGISTRY_PASSWORD
# - DOCKER_IMAGE_PREFIX (optionnel, sinon $CI_REGISTRY_IMAGE est utilisé)
docker-push:
  image: docker:25-cli
  stage: docker
  services:
    - docker:25-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  dependencies:
    - docker-build
  before_script:
    - echo "Logging in to registry ${CI_REGISTRY}"
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - docker build -t ${DOCKER_IMAGE_PREFIX}/wisherr-backend:${CI_COMMIT_SHORT_SHA} ./backend
    - docker build -t ${DOCKER_IMAGE_PREFIX}/wisherr-frontend:${CI_COMMIT_SHORT_SHA} -f ./frontend/Dockerfile.prod ./frontend
    - docker tag ${DOCKER_IMAGE_PREFIX}/wisherr-backend:${CI_COMMIT_SHORT_SHA} ${DOCKER_IMAGE_PREFIX}/wisherr-backend:latest
    - docker tag ${DOCKER_IMAGE_PREFIX}/wisherr-frontend:${CI_COMMIT_SHORT_SHA} ${DOCKER_IMAGE_PREFIX}/wisherr-frontend:latest
    - docker push ${DOCKER_IMAGE_PREFIX}/wisherr-backend:${CI_COMMIT_SHORT_SHA}
    - docker push ${DOCKER_IMAGE_PREFIX}/wisherr-frontend:${CI_COMMIT_SHORT_SHA}
    - docker push ${DOCKER_IMAGE_PREFIX}/wisherr-backend:latest
    - docker push ${DOCKER_IMAGE_PREFIX}/wisherr-frontend:latest
  only:
    - main
    - master
  when: manual
  allow_failure: false

# ---------------------------
# Deploy (manual placeholder)
# ---------------------------
# Deploy placeholder: utilisez vos scripts/deployer (SSH, kubectl, helm, etc.)
deploy:staging:
  image: alpine:3.17
  stage: deploy
  before_script:
    - apk add --no-cache curl bash ca-certificates
  script:
    - echo "Manual deploy step - implement your CD here. Use CI variables to authenticate and deploy."
    - echo "Available variables you may want to set in Settings > CI/CD > Variables:"
    - echo "  DEPLOY_HOST, DEPLOY_USER, DEPLOY_SSH_KEY, KUBE_CONFIG, HELM_REPO, ..."
  when: manual
  only:
    - main
    - master
